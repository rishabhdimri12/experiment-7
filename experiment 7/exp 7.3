const express = require('express');
const mongoose = require('mongoose');
const bodyParser = require('body-parser');

const app = express();
app.use(bodyParser.json());

mongoose.connect('mongodb://127.0.0.1:27017/bankDB', { useNewUrlParser: true, useUnifiedTopology: true });

const accountSchema = new mongoose.Schema({
  name: String,
  balance: Number
});

const Account = mongoose.model('Account', accountSchema);

app.post('/transfer', async (req, res) => {
  const { sender, receiver, amount } = req.body;
  if (!sender || !receiver || !amount || amount <= 0) return res.status(400).json({ error: 'Invalid input data' });

  const senderAcc = await Account.findOne({ name: sender });
  const receiverAcc = await Account.findOne({ name: receiver });

  if (!senderAcc || !receiverAcc) return res.status(404).json({ error: 'Sender or receiver account not found' });
  if (senderAcc.balance < amount) return res.status(400).json({ error: 'Insufficient balance' });

  senderAcc.balance -= amount;
  receiverAcc.balance += amount;

  await senderAcc.save();
  await receiverAcc.save();

  res.json({ message: 'Transfer successful', senderBalance: senderAcc.balance, receiverBalance: receiverAcc.balance });
});

app.post('/create', async (req, res) => {
  const { name, balance } = req.body;
  if (!name || balance == null || balance < 0) return res.status(400).json({ error: 'Invalid account data' });
  const acc = new Account({ name, balance });
  await acc.save();
  res.json({ message: 'Account created', account: acc });
});

app.get('/accounts', async (req, res) => {
  const accounts = await Account.find();
  res.json(accounts);
});

const PORT = 3000;
app.listen(PORT, () => console.log(`Server running on http://localhost:${PORT}`));

